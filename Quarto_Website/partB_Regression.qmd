---
title: "Linear Regression Analysis and Visualisation"
format: html
---

```{r}
#| label: Install and Load Libraries
#| message: true
#| warning: true

# Install packages, load libraries
if(!require("tidyverse"))
  install.packages("tidyverse")
  library(tidyverse)

if(!require("DBI"))
  install.packages("DBI")
  library(DBI)

if(!require("RSQLite"))
  install.packages("RSQLite")
  library(RSQLite)

if(!require("kableExtra"))
  install.packages("kableExtra")
  library(kableExtra)

if(!require("DT"))
  install.packages("DT")
  library(DT)

if(!require("ggplot2"))
  install.packages("ggplot2")
  library(ggplot2)

if(!require("dplyr"))
  install.packages("dplyr")
  library(dplyr)

if(!require("broom"))
  install.packages("broom")
  library(broom)

# Connect to database
conn <- dbConnect(RSQLite::SQLite(), "virtual_production.db")

```

```{r}
#| label: Part 1 DB Query
#| message: true
#| warning: true

# Select information from production, title and budget, Count the unique crew members on each and assign value to production status from the Productions table and Join with ProductionCrew Table and group by ID, Title, Budget and Status

# Queries the database and runs part1
data <- dbGetQuery(conn, "SELECT p.productionID, p.Title, p.Budget, COUNT(DISTINCT pc.CrewID) AS CrewSize, p.Status FROM Productions p LEFT JOIN ProductionCrew pc ON p.ProductionID = pc.ProductionID GROUP BY p.ProductionID, p.Title, p.Budget, p.Status;")

data <- data %>% mutate(SuccessRate = case_when(Status == "Completed" ~ 1, Status == "Post-Production" ~ 0.75, Status == "Shooting" ~ 0.5, TRUE ~ 0.25))


# Predict SuccessRate based on Budget & Crewsize using a linear model
model <- lm(SuccessRate ~ Budget + CrewSize, data = data)
summary(model)

# Plot results of SuccessRate to a scatterplt chart
ggplot(data, aes(x = Budget, y = SuccessRate)) + geom_point(aes(size = CrewSize, color = CrewSize)) + geom_smooth(method = "lm", se = FALSE, color = "blue") + labs(title = "Budget vs Success Rate", x = "Budget (Currency Units", y = "Success Rate", caption = "Linear trend line with Crew Size indicated by color") + theme_minimal()

```

```{r}
#| label: Extract Coefficents
#| message: true
#| warning: true
#| paged-print: true

# Extract coeffecients and display in a table
model_tidy <-tidy(model)
kable(model_tidy, caption = "Linear Regression Coefficients") %>% kable_styling(full_width = FALSE)

```
